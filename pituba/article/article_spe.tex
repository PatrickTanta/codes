% This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.


% Review
%\documentclass[authoryear,preprint,review,11pt]{elsarticle}
\documentclass[final,authoryear,5p,twocolumn,10pt]{elsarticle}

% Review topics:

% % TERMINOLOGY
% % fluid saturations or phase saturations?
% % Block-Oil, Black-oil or black-oil?


%% for a journal layout:
%% \documentclass[final,authoryear,1p,times]{elsarticle}
%% \documentclass[final,authoryear,1p,times,twocolumn]{elsarticle}
%% \documentclass[final,authoryear,3p,times]{elsarticle}
%% \documentclass[final,authoryear,3p,times,twocolumn]{elsarticle}
%% \documentclass[final,authoryear,5p,times]{elsarticle}

% Pending modifications:
% - Add bubble-point pressure to equations after volume and time integration.
% - A different fluid distribution DOES NOT lead to a different value of averaged saturation.
% - CORRECTION: saturations need not be constant in order to Bubble-point pressure be constant.

%\documentclass[final,authoryear,5p,times,twocolumn,11pt]{elsarticle}

\usepackage{lineno}
\usepackage{amsmath}
\usepackage{natbib}
\usepackage{booktabs}
%opening

\newtheorem{prop}{Proposition}
\newtheorem{remark}{Remark}
\newtheorem{step}{Step}


\begin{document}
\begin{frontmatter}
\title{Solution of hydrodynamic equilibrium in black-oil reservoirs: the classical material balance equation}
%\title{Obtaining the classical material balance equation from black-oil equations}
%\journal{Journal of Petroleum Science and Engineering}
%\author{R.B. Piccinini}\ead{rbpiccinini@gmail.com}

%
%This work derives the classical material balance equation from the more general black-oil model. It is shown that spatially averaged PVT properties are required for the material balance approach in general, but that for many cases the averaging is simply negligible for practical purposes.  An interpretation for pressure in material balance equation is provided and its relation to a datum level is examined. The material balance equation is formulated for a varying bubble-point pressure and sufficient conditions for solution uniqueness are presented. A scheme for numerical solution is also proposed.



\begin{abstract}
It is generally known that the material balance equation can be derived from a 3D black-oil model typical of reservoir simulation. However, the existing literature is not comprehensive about what are the needed assumptions and how the pressure calculated from the material balance equation relates to the pressure field of a 3D black-oil model.

This work examines underlying details in obtaining the material balance equation from a 3D black-oil model. The black-oil equations are integrated in reservoir volume and quantities are averaged in space. The material balance equation is obtained for the averaged quantities and it is applied to calculate reservoir pressure. It is shown that this calculated pressure corresponds to the pressure at a chosen datum level in the 3D black-oil model (and not, in general, to the average pressure of the 3D model). The definition of a convenient datum level is also discussed. It is found that the physical correctness of PVT properties 
is a sufficient condition for solution uniqueness of the material balance equation when pressure is the unknown quantity.
Finally, a numerical scheme for solving the material balance equation is proposed based on nonlinear root finding algorithms.
\end{abstract}

\begin{keyword}
material balance \sep black-oil equations \sep reservoir engineering.
\end{keyword}
\end{frontmatter}

\section{Introduction}
The material balance equation is a classical tool in petroleum reservoir engineering. It consists of the algebraic equation originally presented in \cite{schilthuis1936active} as a zero dimensional model for estimating reservoir pressure from mass balance. \cite{schilthuis1936active} introduced the hypothesis of mechanical equilibrium attained at all times not necessarily in the entire reservoir volume, but in the regions of high permeability where most of the production would come from and where pressure would present a similar trend. Such regions were said to contain an active oil. 

The equation developed by \cite{schilthuis1936active} did not account for the non-existence of hydrodynamic, chemical or thermal equilibrium. An attempt to introduce non-equilibrium effects of hydrodynamic origin came with \textit{black-oil} equations \citep{aziz1979petroleum,blackoil}. The novelty on hydrodynamics was the introduction of a macroscopic equation of motion using Darcy's law. Black-oil equations are usually solved for in three dimensional models that aim to predict the pressure field responsible for reservoir fluid flow.

Many works have reported applications of the material balance equation in the literature, but few have explored its connection with black-oil equations. \cite{ertekin2001basic} briefly addressed this subject arguing both approaches to be equivalent if capillarity and gradients of flow potential ($\nabla \Phi = \nabla p - \rho \vec{g}$) were neglected and if PVT properties were averaged in reservoir volume. This work develops on those concepts and proposes an averaging scheme for flow properties. Subsequently, it suggest how the pressure computed from material balance equation can be compared to the pressure field in 3D black-oil models.

%Black-oil equations arise from the generalization of the zero dimensional concept to a three-dimensional model that incorporates Darcy's law and entails the same approach for phase equilibrium \citep{aziz1979petroleum}.

The term black-oil in this context refers to specific hydrocarbon compositions to which phase equilibrium can be described by a two pseudo-component system. For such reservoir fluids, gas phase composition remains essentially constant in the range of pressure and temperature observed during production so that a pseudo-gas component can be defined. Similarly, a pseudo-oil component can be defined by subtraction of the pseudo-gas component from the oil phase composition. After defining the pseudo-components, the number of transport equations needed for hydrocarbon components is reduced from a usually large number to only two.

%A general restriction of this approach is that reservoir temperature must be sufficiently below the mixture critical temperature so that different fluid phases have clearly distinguishable properties \citep{danesh1998pvt,firoozabadi1999thermodynamics}.

%Since black-oil and material balance equation differ only on spatial scale and the existence of local pressure gradients, there must exist conditions under which material balance equation might be recovered from the black-oil approach. This work examines such conditions.

%Many applications of the material balance equation have been reported in the literature, but few of them explore its connection with black-oil equations. \cite{ertekin2001basic} briefly addressed this subject arguing both approaches to be equivalent if capillarity and gradients of flow potential ($\nabla \Phi = \nabla p - \rho \vec{g}$) were neglected and if PVT properties were averaged in reservoir volume. This work develops this process examining underlying details.



%\begin{subequations}
%\begin{equation}
%p_\alpha = p \, ,
%\end{equation}
%\begin{equation}
%\nabla \Phi_\alpha = \nabla p_\alpha - \rho_\alpha g \nabla z = 0 \, ,
%\end{equation}
%\end{subequations}
%for $\alpha=o,g,w$ referring to oil, gas and water phases.

%It is shown in this work that a stronger assumption is actually needed: mechanical equilibrium in the presence of gravity ($\nabla p = \rho g \nabla z$) is not a sufficient condition, pressure gradients must identically vanish instead ($\nabla p_\alpha \equiv 0$).
%\begin{equation}
%\nabla p \equiv 0 \, .
%\end{equation}

%The restriction of a spatially constant pressure throughout the reservoir does not require PVT properties to be averaged during the integration procedure. Such averaging process is not straightforward, if not impractical, as it is shown later. For the same reason, bubble-point pressure must also be constant and it is shown that this latter assumption is equivalent to having constant fluid saturations in space.

%The requirement of a spatially constant pressure makes the material balance equation more suitable for shallow reservoirs, where gravity field is less important in phase equilibrium.

 The same approach of varying bubble-point pressure widely used in reservoir simulation, which is found in \cite{aziz1979petroleum} and \cite{ertekin2001basic}, is also applied here. This approach extends the material balance equation to saturated reservoirs under pressure maintenance (e.g. fluid injection). The applicability, however, requires negligible non-equilibrium effects.

%It has already been shown the importance of not having strong flow near interface that prevents mixing and causes pressure to drop locally \citep{steffensen1973reservoir,utseth1981numerical}.

After presenting the material balance equation, sufficient conditions are shown for which the material balance equation has only one solution for pressure. These conditions require fluids to be compressible and gas vaporization to occur with increase of oil phase density. A simple scheme for numerical solution is also proposed based on classical root-finding algorithms for non-linear equations.

%\section{Black-oil equations}
%
%Here it is used a thermodynamic fluid model known as Black-Oil \cite{blackoil}. It consists of a simplified treatment of hydrocarbon composition and phase equilibrium. Hydrocarbon species are grouped into two pseudo-components called oil and gas, being a pseudo-component one which consists of more than one chemical molecule.
%
%Oil is composed by hydrocarbon species that remain in liquid phase for standard surface pressure and temperature. The other hydrocarbon species in gaseous phase for the same surface condition are called gas.
%
%The mixture of reservoir fluid is then composed of oil, gas and water components and can present three fluid phases: oil, gas and water. Oil phase may be composed of oil and gas components, gaseous phase may be composed uniquely by gas component and water phase uniquely by water component.
%
%In addition to the three fluid components and phases, there is a solid phase composed by the rock.
%
%The fluid phases may be defined in a more general framework so as to account for dissolution of gas in water or water vapour, for instance. Such possibilities are not dealt with in this work.
%
%For some volume containing one of the three fluid phases, the saturation of the fluid phase $k$ is defined as
%\begin{equation}\label{eq: saturation}
%S_{k}=\frac{\phi_k}{\sum_{i \neq solid} \phi_i} \, ,
%\end{equation}
%where $\phi_i$ is the volume fraction of the fluid phase $i$.
%
%In order to apply the volume balance, a control volume ($\Omega$) is defined containing all the hydrocarbon zone. It consists of the region where hydrocarbon saturation is greater than zero for some arbitrarily small volume. This reservoir definition excludes the pure water zone, which is referred to as the aquifer.
%
%
%Right hand side of Equation \eqref{eq: matbal1}, \textit{rock and fluid expansion}, is a function of phase mass transfers and compressibilities. Both should be obtained from a thermodynamic model accounting for mass transfer among phases and the relation between phase volumes and pressure. Temperature is seldom considered to vary during reservoir production and it is held constant and equal in all phases, not being an independent property of the control volume state.
%
%Such thermodynamic model is presented in detail in \cite{blackoil} and it is commonly referred to as Black-Oil Equations. The main assumption behind them is that phase and pressure equilibria are instantaneously achieved inside the control volume, i.e., mass transfer among phases reaches equilibrium and internal forces equilibrate external ones fast enough in comparison to the interval of time between two observations of control volume properties.
%
%Pressure in each phase may differ if capillary forces are taken into account, for what extra constitutive equations relating each phase pressures would be needed.
%Capillary pressure would be function of porous medium properties given by some porous medium model, e.g., permeability and porosity; phase properties, e.g., surface tension and wettability, and the thermodynamic state.
%
%Capillary pressure is very often assumed to be function of phase saturations only and, hence, the thermodynamic state of the control volume would be completely determined by the pressure of one phase (e.g. the wetting phase) and phase saturations.
%
%Black-Oil Equations do not assume water and oil phases becoming miscible for any thermodynamic state.
%
%Capillary pressure dependence on phase saturation only is often considered as a weak assumption in contradiction with experimental observations. The hysteresis of capillary pressure exhibited when either imbibition or drainage occurs is not theoretically explained and it is accounted for by empirical relations or it is rather simply neglected.
%
%\cite{hilfer1} has proposed the inclusion of an energy equation.

\section{Derivation of equations}

This section presents black-oil equations, performs the averaging of quantities in space and examines simplifying assumptions necessary to obtain the material balance equation.

\subsection{Black-oil equations}

% As already mentioned, black-oil is a designation to a simplified treatment of hydrocarbon composition and phase equilibrium. Hydrocarbon species are grouped into two pseudo-components called oil and gas, being a pseudo-component one that consists of more than one chemical molecule.

% Oil component, also called stock tank oil, is defined as the hydrocarbon composition in liquid phase for standard surface pressure and temperature. Similarly, gas component is the hydrocarbon composition in gaseous phase for the same surface condition. All species are generally present in both phases although the equilibrium composition is shifted to liquid phase (or gaseous phase) for components of greater (lower) molecular mass.

%Phase saturation is defined as the fraction of the occupied pore volume:
%\begin{equation}
%S_\alpha = \frac{\phi_\alpha}{\phi} \, ,
%\end{equation}
%where $\phi_\alpha$ is the volumetric fraction of a fluid phase $\alpha$ and $\phi$ is the porosity. Clearly, all saturations sum up to unity. 
%\begin{equation}
%S_o + S_g +S_w = 1 \, .
%\end{equation}

We assume that the reservoir is a hydraulically connected volume where hydrocarbon saturation is nonzero. By a hidraulically connected volume, we mean that it is possible to observe a common pressure decline trend when any reservoir portion is under production \citep{dakepractice}. Reservoir fluids are composed of oil and gas pseudo-components and water component. There can be three fluid phases at most: oil, gas and liquid water. Oil phase is composed of oil and gas components, gas phase is composed uniquely by gas component and, water phase, uniquely by water component. The only allowed mass transfer is of gas component between oil and gas phases. The gas phase composition is always that of a dry gas.

%In addition to the three fluid components and phases, there is the solid phase composed by the rock.

Mass balance equation for each component reads:

\begin{itemize}
\item water component:
\begin{equation}\label{eq: Sw1}
\frac{\partial}{\partial t} \left( \rho_w S_w \phi \right) +\nabla \cdot \left( \rho_w \vec{u}_w \right) = 0 ;
\end{equation}

\item oil component:
\begin{equation}\label{eq: So1}
\frac{\partial}{\partial t}\left( \rho_o Y_o S_o \phi \right) + \nabla \cdot \left( \rho_o Y_o \vec{u}_o \right) = 0 \, ;
\end{equation}

\item gas component:
\begin{equation}\label{eq: Sg1}
\begin{split}
\frac{\partial}{\partial t} \left[\left( \rho_o Y_g S_o + \rho_g S_g\right)\phi \right] + \nabla  \cdot \left( \rho_o Y_g \vec{u}_o + \rho_g \vec{u}_g\right) = 0\, .
\end{split}
\end{equation}
\end{itemize}
Mass concentrations of oil and gas components in oil phase are denoted by $Y_o$ and $Y_g$, respectively. 

Initial conditions are of no fluid motion. Boundary conditions are of no normal flow at all boundaries except for interfaces with wells or aquifers.

A common simplification in black-oil formulation is to restrict mass transport to macroscopic advection. No diffusive or dispersive term is included in mass balance equations. 

%This simplification must be looked with care when gradients of species concentration are important. For instance, when gas is being dissolved in oil phase in a reservoir under repressurization, this condition is not generally true.

%and $\nabla Y_i \approx 0$ does not hold for some species $i$. For instance, when gas is being dissolved in oil phase in a reservoir under repressurization, this condition is not generally true.

%Mass balance equations for each fluid phase are \citep{ertekin2001basic}:
%% Oleo
%\begin{equation}\label{eq: So1}
%\frac{\partial}{\partial t}\left(\frac{\phi(p_P) S_o}{B_o(p_o,P_b)}\right)+\nabla\cdot\left(\frac{\vec{u}_o}{B_o (p_o,P_b)}\right)=q_{os} \, ,
%\end{equation}
%% Gas
%\begin{equation}
%\begin{split}\label{eq: Sg1}
%\frac{\partial}{\partial t}\left[\phi(p_P)\left(\frac{S_g}{B_g (p_g)} +\frac{S_o R_s (p_o,P_b)}{B_o (p_o,P_b)}\right)\right] \\
%+\nabla\cdot\left(\frac{\vec{u}_o R_s (p_o,P_b)}{B_o (p_o,P_b)}+\frac{\vec{u}_g}{B_g (p_g)}\right)=q_{gs} \, ,
%\end{split}
%\end{equation}
%% Agua
%\begin{equation}\label{eq: Sw1}
%\frac{\partial}{\partial t}\left(\frac{\phi (p_P) S_w}{B_w (p_w)}\right)+\nabla\cdot\left(\frac{\vec{u}_w}{B_w(p_w)}\right)=q_{ws} \, ,
%\end{equation}
%
%where saturations must satisfy the constraint
%\begin{equation}\label{eq: S11}
%S_o+S_w+S_g=1 \, .
%\end{equation}
%
%Bubble-point pressure ($P_b$) is here defined as the minimum pressure for which gas phase is locally absent, i.e., $S_g=0$. Its local value is implicitly given by the solubility ratio ($R_s$) satisfying the equation:
%\begin{equation}\label{eq: Pb}
%R_s(p_o=P_b,P_b) = \frac{B_g(p_g)}{B_o(p_o,P_b)}\frac{S_g}{S_o} +R_s(p_o,P_b) \, .
%\end{equation}
%It must be remarked that bubble-point pressure is sometimes defined in a different manner as the bubble-point pressure for the hydrocarbon composition in oil phase only. According to this latter definition, $P_b = p_o$ for any saturated reservoir.
%
%Black-oil equations make the assumption of instantaneous mass transfer between oil and gas phases, what is only reasonable for a reservoir under depletion, when oil and gas components are homonegeously distributed in oil phase. Once constant temperature and fluid composition are assumed, diffusion and advection of species and energy become unimportante for phase equilibrium calculations.
%
%If gradients of species concentration are present within oil phase, however, as it occurs in saturated reservoirs under pressure maintenance, a combined mechanism of advection and diffusion exists and those are absent of black-oil equations. Some heuristic models have been proposed for problems where this issue is critical, as for gas injection projects. \cite{utseth1981numerical} has proposed to limit $dR_s/dt$ and neglect transport of gas component in oil phase for a simplified treatment.

Momentum balance for each phase is given by an extension of Darcy's law to multiphase flow. This extension consists in multiplying absolute (or single-phase) permeability ($\vec{\vec{k}}$) by a scalar function called phase relative permeability ($k_{r,\alpha}$):

\begin{equation}\label{eq: exdarcy}
\vec{u}_\alpha = -\frac{k_{r,\alpha} \vec{\vec{k}}}{\mu_\alpha}\cdot \left(\nabla p_\alpha - \rho_\alpha \vec{g}\right) \, , \quad \alpha=o,w,g \, .
\end{equation}

%Phase densities are functions of the local thermodynamic state:
%\begin{equation}
%\rho_w = \rho_w \left(p_w, T_w\right) \, ,
%\end{equation}
%\begin{equation}
%\rho_o = \rho_o \left(p_o, T_o,Y_g\right) \, ,
%\end{equation}
%\begin{equation}
%\rho_g = \rho_g \left(p_g, T_g\right) \, .
%\end{equation}

Another simplification is now made assuming thermal equilibrium in the reservoir volume, i.e.,
\begin{equation}
T_w = T_o = T_g = T_{rock} = T = \text{constant} \, .
\end{equation}
Temperature is a constant prescribed value and no equation for energy balance is needed. 

%Temperature is a constant prescribed value and no equation for energy balance is needed. It follows from Gibbs' phase rule that the equilibrium of oil and gas phases has only two degrees of freedom if the component number is restricted to the two pseudo-components. As temperature is assumed constant, oil phase density is a function of pressure alone. The same is valid for mass fractions of gas and oil components in oil phase:

It follows from Duhem's theorem that the equilibrium of oil and gas phases is determined if, in addition to the mass balance equations, two other properties are prescribed. From Gibbs' phase rule, the oil an gas system has two degrees of freedom. It is then necessary to specify two intensive properties. The constant temperature is one and the local pressure is chosen as the other. Since temperature was assumed constant, oil phase density becomes a function of pressure alone. The same is valid for mass fractions of gas and oil components in the oil phase:
\begin{equation}
\rho_o = \rho_o \left(p_o\right) \, , \quad Y_g = Y_g (p_o) \, , \quad Y_o = Y_o (p_o) \, .
\end{equation}

When the oil phase is undersaturated, the system has one additional degree of freedom and both pressure and the amount of dissolved gas must be known to define its thermodynamic state, e.g., $\rho_o = \rho_o (p_o,Y_o)$.

Porosity ($\phi$) is assumed a function of pore pressure ($p_P$). Because three phases are present in general, such quantity is defined by some relation of the type \citep{kim2011rigorous}:
\begin{equation}
p_P=p_P\left(p_o,p_w,p_g,S_o,S_w,S_g\right) \, .
\end{equation}

To close the system of equations, a connection among different phase pressures is provided by capillary pressure relations:
%capillary
\begin{equation}\label{eq: capillary_ow}
p_{c,ow}=p_o-p_w \, ,
\end{equation}
\begin{equation}\label{eq: capillary_og}
p_{c,go}=p_g-p_o \, .
\end{equation}


%Capillary pressure and relative permeability are controversial concepts in the sense that they have not been demonstrated to arise from theoretical foundations. For practical applications, both functions are usually assumed in the forms presented above and their properties are argued to be empirically established.

%It is well known that black-oil equations possess discontinuous solutions in saturation, bubble pressure and solubility ratio fields. Discontinuities (or shocks) are introduced by initial or boundary conditions and are propagated throughout flow domain due to the hyperbolicity of equations.
%
%In initial conditions, if hydrostatic equilibrium is imposed and no capillary pressure is included, that is,
%\begin{equation}
%p_{c,ow}=p_{c,og}=0 \quad \longrightarrow \quad p_o=p_w=p_g=p\, ,
%\end{equation}
%saturation discontinuities will be present due to gravity segregation.
%
%When capillary pressure is present and it is function of phase saturations, a diffusive term is introduced in mass balance equations and shocks originated by phase displacement become smoothed:
%\begin{equation}
%\frac{\partial}{\partial t}\left(\frac{\phi (p_P) S_w}{B_w (p_w)}\right)-\nabla\cdot\left[\frac{k_{r,w} \vec{\vec{k}}}{B_w(p_w)\mu_w} \left(\nabla p_o - \rho_w g\nabla z -\underbrace{\frac{d p_c}{d S_w}\nabla S_w}_{\text{water diffusion}}\right)\right]=q_{ws} \, .
%\end{equation}
%
%Discontinuities in saturation may still occur, however, if capillary pressures are functions of discontinuous porous medium properties ($phi$ and $\vec{\vec{k}}$) or if phase change takes place, as diffusion of gas dissolved in oil phase is not allowed.
%Cite Bear and Herrera.


\subsection{Material balance equation}

Derivation of the material balance equation consists in integrating black-oil equations in reservoir volume ($\Omega$).

%Defining averages of most quantities is difficulty, though, as they appear in equations as products of up to three factors. Being the quantities self-correlated, the averaging process would involve unclosed terms. Quantities are thus required to be spatially constant wherever needed.

%A second problem is that averaging requires the knowledge of a spatial distribution of quantities for it be uniquely specified, as it can be seen for an average saturation depending on spatial distributions of local saturation and porosity,
%\begin{equation}\label{eq: avS}
%\bar{S}_\alpha = \int_\Omega S_\alpha \phi dV \, .
%\end{equation}

Integrating Eqs.~\eqref{eq: Sw1}, \eqref{eq: So1} and \eqref{eq: Sg1} in volume and applying divergence theorem gives:
\begin{itemize}
\item water component:
\begin{align}\label{eq: Sw2}
\begin{split}
\frac{\partial}{\partial t} \int\limits_{\Omega} \rho_w S_w \phi dV &= - \oint_{\partial \Omega} \rho_w \left( \vec{u}_w \cdot \vec{dS} \right) \\
&= \rho_w^{ST}\left(Q_{we}^{ST} + Q_{wi}^{ST}-Q_w^{ST}\right) \, ;
\end{split}
\end{align}

\item oil component:
\begin{align}\label{eq: So2}
\begin{split}
\frac{\partial}{\partial t} \int\limits_{\Omega} \rho_o Y_o S_o \phi dV &= -\oint_{\partial \Omega} \rho_o Y_o \left(\vec{u}_o \cdot \vec{dS} \right) \\
&= - \rho_o^{ST}Q_o^{ST} \, ;
\end{split}
\end{align}

\item gas component:
\begin{align}\label{eq: Sg2}
\begin{split}
\frac{\partial}{\partial t} \int\limits_{\Omega} \left( \rho_o Y_g S_o + \rho_g S_g\right) \phi dV &= - \oint_{\partial \Omega} \left( \rho_o Y_g \vec{u}_o + \rho_g \vec{u}_g\right) \cdot \vec{dS} \\
&=  \rho_g^{ST}(Q_{gi}^{ST}-Q_g^{ST}) \, .
\end{split}
\end{align}
\end{itemize}
%
%\begin{itemize}
%\item water component:
%\begin{equation}\label{eq: Sw2}
%\frac{\partial}{\partial t} \int\limits_{\Omega} \rho_w S_w \phi dV = \rho_w^{ST}Q_w^{ST} \, ;
%\end{equation}
%
%\item oil component:
%\begin{equation}\label{eq: So2}
%\frac{\partial}{\partial t} \int\limits_{\Omega} \rho_o Y_o S_o \phi dV = \rho_o^{ST}Q_o^{ST} \, ;
%\end{equation}
%
%\item gas component:
%\begin{equation}\label{eq: Sg2}
%\frac{\partial}{\partial t} \int\limits_{\Omega} \left( \rho_o Y_g S_o + \rho_g S_g\right) \phi dV = \rho_g^{ST}Q_g^{ST} \, .
%\end{equation}
%\end{itemize}
%
\subsubsection{Averaging quantities}

Spatially averaged quantities are defined for porosity ($\phi$), phase saturation ($S_\alpha$), density ($\rho_\alpha$) and mass concentration of a component $k$ in phase $\alpha$ ($Y_{\alpha,k}$).

All quantities are initially functions of space and time, but they become functions of time alone after being averaged in space:

\begin{equation}
\bar{\phi} (t) = \frac{1}{\Omega}\int_{\Omega}\phi \left(\vec{x},t\right) dV \, .
\end{equation}

Omitting function arguments:
\begin{equation}
\bar{S}_\alpha\bar{\phi} = \frac{1}{\Omega}\int_{\Omega}S_\alpha \phi dV \, ,
\end{equation}

\begin{equation}
\bar{\rho_\alpha}\bar{S}_\alpha \bar{\phi} = \frac{1}{\Omega}\int_{\Omega}\rho_\alpha S_\alpha \phi dV \, ,
\end{equation}

\begin{equation}
\bar{\rho}_\alpha \bar{Y}_{\alpha,k}\bar{S}_\alpha \bar{\phi} = \frac{1}{\Omega}\int_{\Omega}\rho_\alpha Y_{\alpha,k} S_\alpha \phi dV \, .
\end{equation}

Eqs. \eqref{eq: Sw2}, \eqref{eq: So2} and \eqref{eq: Sg2} can now be rewritten in terms of averaged quantities:

\begin{itemize}
\item water component:
\begin{equation}\label{eq: Sw3}
\frac{\partial}{\partial t} \left( \bar{\rho_w}\bar{S}_w\bar{\phi} \Omega \right) = \rho_w^{ST}\left(Q_{we}^{ST} + Q_{wi}^{ST}-Q_w^{ST}\right)
\end{equation}

\item oil component:
\begin{equation}\label{eq: So3}
\frac{\partial}{\partial t} \left( \bar{\rho_o}\bar{Y}_o\bar{S}_o\bar{\phi} \Omega \right) = - \rho_o^{ST}Q_o^{ST}
\end{equation}

\item gas component:
\begin{equation}\label{eq: Sg3}
\frac{\partial}{\partial t} \left[\left( \bar{\rho}_o\bar{Y}_g \bar{S}_o + \bar{\rho}_g \bar{S}_g \right) \bar{\phi} \Omega\right] =  \rho_g^{ST}(Q_{gi}^{ST}-Q_g^{ST}) \, .
\end{equation}
\end{itemize}

Usual definitions from petroleum engineering can be introduced for the description of volumetric and solubility changes. For volumetric changes, $B_w$, $B_o$ and $B_g$, the formation volume factors of water, oil and gas phases, respectively, express the ratio of a phase volume at reservoir condition to its volume at standard surface condition, i.e.:

\begin{equation}\label{eq: Bw}
B_w = \frac{\rho_w^{ST}}{\bar{\rho}_w} \, ,
\end{equation}

\begin{equation}\label{eq: Bo}
B_o = \frac{\rho_o^{ST}}{\bar{Y}_o \bar{\rho}_o} \, ,
\end{equation}

\begin{equation}\label{eq: Bg}
B_g = \frac{\rho_g^{ST}}{\bar{\rho}_g} \, .
\end{equation}

For changes in gas solubility in oil phase, the solubility ratio ($R_s$) gives the ratio between the volume of dissolved gas and the volume of oil both measured at surface condition:

\begin{equation}
R_s = \frac{\rho_o^{ST} / \bar{Y}_o}{\rho_g^{ST} / \bar{Y}_g} \, ,
\end{equation}

or, using $\bar{Y}_o + \bar{Y}_g = 1$:
\begin{equation}
R_s = \frac{\rho_o^{ST}}{\rho_g^{ST}}\frac{\bar{Y}_g}{1-\bar{Y}_g} \, .
\end{equation}

Equations can now be rewritten using the above definitions and denoting porous volume by $V_p = \bar{\phi}\Omega$.

\begin{equation}\label{eq: Sw4}
\frac{\partial}{\partial t} \left(\frac{\bar{S}_w V_p}{B_w} \right) = Q_{we}^{ST} + Q_{wi}^{ST}-Q_w^{ST}
\end{equation}

\begin{equation}\label{eq: So4}
\frac{\partial}{\partial t} \left(\frac{\bar{S}_o V_p}{B_o} \right) = - Q_o^{ST} \, ,
\end{equation}

\begin{equation}\label{eq: Sg4}
\frac{\partial}{\partial t} \left[ V_p \left(\frac{\bar{S}_g}{B_g} + \frac{\bar{S}_o R_s}{B_o} \right) \right] = \left( Q_{gi}^{ST}-Q_g^{ST} \right) \, ,
\end{equation}

\begin{equation}\label{eq: S14}
\bar{S}_w+\bar{S}_o+\bar{S}_g=1 \, .
\end{equation}

Integrating Eqs.~\eqref{eq: Sw4}, \eqref{eq: So4} and \eqref{eq: Sg4} between times $t_1$ and $t_2$ gives:
% Water
\begin{equation}\label{eq: Sw5}
\frac{V_{p2} \bar{S}_{w2}}{B_{w2}}=W+\left(W_i+W_e-W_p\right) \, ,
\end{equation}

% Oil
\begin{equation}\label{eq: So5}
\frac{\bar{S}_{o2} V_{p2}}{B_{o2}} = N-N_p \, ,
\end{equation}

% Gas
\begin{equation}\label{eq: Sg5}
V_{p2}\left(\frac{\bar{S}_{g2}}{B_{g2}} +\frac{\bar{S}_{o2} R_{s2}}{B_{o2}}\right) = N\left(m\frac{B_{o1}}{B_{g1}} + R_{s1}\right) +\left(G_i-G_p\right) \, ,
\end{equation}
%
\begin{equation}\label{eq: S15}
\bar{S}_o+\bar{S}_w+\bar{S}_g=1 \, .
\end{equation}

Where $N=V_{p1} \bar{S}_{o1}/B_{o1}$ and $W=V_{p1} \bar{S}_{w1}/B_{w1}$ are the initial volumes of oil and water measured at surface condition and $m=V_{p1} \bar{S}_{g1}/B_{o1} N$ is the ratio of the initial volumes of gas and oil phases measured at reservoir condition.

An implicit equation for the bubble-point can be obtained by setting $\bar{S}_{g2}=0$ in Eq.~\eqref{eq: Sg5} and solving it for the solubility ratio at bubble-point pressure, $R_s(p=P_b)$:
\begin{equation}\label{eq: eqPb}
\begin{split}
R_{s2}\left(p=P_b\right) = &\Big[N\left(m B_{1}/B_{g1} +R_{s1}\right)\\
&+G_i-G_p\Big]/\left(N-N_p\right) \, .
\end{split}
\end{equation}

\subsubsection{Material balance equation}

It is now possible to obtain the generalized material balance equation by substituting the equations for phase saturation, Eqs.~\eqref{eq: Sw5}, \eqref{eq: So5} and \eqref{eq: Sg5}, into Eq.~\eqref{eq: S15}:  

\begin{equation}\label{eq: MBE}
F_p - F_i= \underbrace{N E_o + mN E_g + W E_w}_{\text{fluid volume expansion } (E)} +\underbrace{V_{p1}-V_{p2}}_{\text{pore volume compaction} (C)}
\end{equation}
or
\begin{equation}\label{eq: MBE_short}
F_p - F_i= E + C \, ,
\end{equation}
where new terms $C$, $E$, $F_i$ and $F_p$ are defined in Table~\ref{tab: MBE}. 

Eq~\eqref{eq: MBE} involves fluid properties, original phase volumes ($N$, $W$ and $G)$, cumulative production and injection and aquifer influx.
It is an algebraic equation that can be solved for any one of its terms, provided that all remaining are known. This work focuses on its solution for pressure.

\subsubsection{Relationship between the material balance equation and reservoir pressure}

% no assumption on static conditions are needed
% pressure field is not known
% pressure field can be assumed constant
% pressure field can be given by hydros tatic equilibrium

The material balance equation is mostly used to relate production and injection to reservoir pressure. In fact, all averaged phase properties in Eq.~\eqref{eq: MBE} depend on the pressure field. If the reservoir is under production, though, the pressure field is not known and for its prediction one would have to resort to more advanced techniques such as reservoir simulation. Further, even if the pressure field were known, one would still need to average fluid properties in space in order to apply Eq.~\eqref{eq: MBE}. In practice, the reservoir engineer is unlikely to perform any averaging of properties since the main reason for using the material balance equation is to avoid the complexities of a 3D reservoir model. 

It can be shown that the averaging of fluid properties can be neglected under the following assumptions:
\begin{itemize}
\item Negligible hydrodynamic gradients and capillarity. This implies that pressure at any time is only a function of depth: $\nabla p = \partial p\partial z = \rho_\alpha \vec{g}$.
\item Phase densities and gas solubility ratio are approximately constant with depth.
\end{itemize}

To show that phase densities can be considered approximately constant with depth, a first order Taylor expansion

%To overcome this difficulty, a possible simplification to the pressure field is to neglect hydrodynamic gradients and assume mechanical equilibrium: $\vec{u}_\alpha \equiv 0$. This implies that pressure at any time instant is only a function of depth: $\nabla p = \partial p_\alpha/\partial z = \rho_\alpha \vec{g}$.



\begin{equation}
\rho_o \left(z\right) \approx \rho_o\left(z_\text{datum}\right)+\left(\frac{\partial \rho_o}{\partial Y_o}\frac{\partial Y_o}{\partial z}+\frac{\partial \rho_o}{\partial p_o}\frac{\partial p_o}{\partial z}\right) dz
\end{equation}


%Although it was not needed to assume no fluid flow to obtain the material balance equation, fluid motion can only be taken into account in the averaging of fluid properties if the pressure field is known. For any practical purpose, this is not true.

% so that pressure is a function of time and depth given by the following expression:
%\begin{equation}\label{eq: p=rhogh}
%\int_{p_\alpha (t,z_{datum})}^{p_\alpha (t,z)} %\frac{dp_\alpha^{'}}{\rho_\alpha \left(p_\alpha^{'}\right)} = g\left(z - %z_{datum}\right) \, ,
%\end{equation}

%where $p_\alpha (t,z)$ is the pressure field of phase $\alpha$ and $p_\alpha (t,z_{datum})$ is the pressure at the datum level $z_{datum}$. If the pressure at the datum level is known, it is possible to compute the pressure field from Eq.~\eqref{eq: p=rhogh} and average fluid properties accordingly.

It will be shown that the pressure field can be further simplified by neglecting the variation of density with depth, what allows us to express the pressure field in the following simple expression:
\begin{equation}
p_\alpha (t,z) = p_\alpha \left(t, z_{datum}\right)+ \rho_\alpha (t, z_{datum}) g \left(z-z_{datum}\right) \, .
\end{equation}

%the same applies to the formation volume factor: $B_o \approx \rho_o (t, z_{datum})/ \rho_o^{ST}$.

%For liquids, a first-order approximation to the relationship between density and pressure at constant temperature and composition can be assumed:

%
%
%
%
%
%Additional assumptions are then needed to simpli
%
%% ERRADO: Using the average reservoir pressure ($\bar{p}$) to compute fluid properties does not solve this issue because $\bar{\rho}_o$ is not equal to $\rho_o (\bar{p})$ and thus $B_o$ is not a simple function of $p$.
%
%What is then the meaning of pressure calculations in material balance equations?
%
%For answering this question, we examine the two roles played by pressure in material balance equation: computation of phase density and phase equilibrium. 
%
%We shall see that to compute the averaged phase density, we may define some datum level and use the corresponding local density as an approximation to the averaged density without introducing any important error. 
\begin{equation}
\rho_o=\rho_o\left(p_o,Y_o\right)
\end{equation}

For an undersaturated oil, $\rho_o$ is a function of pressure and the amount of dissolved gas:
 %As pressure increases with depth according to the hydrostatic gradient, density also increases but by a negligible amount. This approximation can be quantified by putting together the expressions for compressibility and hydrostatic equilibrium. For an undersaturated oil with no compositional gradient,
 \begin{equation}
\frac{1}{\rho_o}\left(\frac{\partial \rho_o}{\partial z} \right)_{T} = \frac{1}{\rho_o}\left(\frac{\partial \rho_o}{\partial p_o} \frac{\partial p_o}{\partial z} + \frac{\partial \rho_o}{\partial Y_o}\frac{\partial Y_o}{\partial z}\right) \, . 
 \end{equation}
Neglecting any compositional gradient, $\partial Y_o/\partial z = 0$, and using the hydrostatic gradient:
\begin{equation}
\frac{1}{\rho_o}\left(\frac{\partial \rho_o}{\partial z} \right)_{T} = c_o \rho_o g \, ,
\end{equation}
 where $c_o$ is the isothermal compressibility.

 For a saturated oil,
 \begin{equation}
\frac{1}{\rho_o}\left(\frac{\partial \rho_o}{\partial z} \right)_T = g\left(\frac{\partial \rho_o}{\partial p_o} \right)_T = 
g\frac{d}{d p_o}\left(\frac{\rho_o^{ST}+R_s\rho_g^{ST}}{B_o}\right) 
 \end{equation}


Similarly for the gas phase, using the state equation $pV = Zn R T$, we obtain its isothermal compressibility:
\begin{equation}
\frac{1}{\rho_g}\left(\frac{\partial \rho_g}{\partial p_g}\right)_{T} = \frac{1}{p_g}-\frac{1}{Z}\frac{\partial Z}{\partial p_g} \, .
\end{equation}

Assuming reservoir temperature to be sufficiently above gas phase critical temperature, we have a negligible variation of the Z-factor with pressure, $\partial Z / \partial p_g \approx 0$. We use hydrostatic equilibrium again and obtain the derivative of gas density with depth:
\begin{equation}\label{eq: gradgdz}
\frac{1}{\rho_g}\left(\frac{\partial \rho_g}{\partial z}\right)_{T} = \frac{\rho_g \vec{g}}{p_g} = \left(\frac{\mathcal{M}}{ Z R T}\right) g \, .
\end{equation}

To investigate the order of magnitude of Eqs.~\eqref{eq: gradodz} and \eqref{eq: gradgdz}, we substitute into them the values of $\rho_o = 10^3\ kg/m^3$ and $c_o = 10^{-9}\ Pa^{-1}$ for the oil phase, and $\mathcal{M}=19\ kg/kmol$ and $T=400\ K$ for the gas phase: 
\begin{equation}
\frac{1}{\rho_o}\left(\frac{\partial \rho_o}{\partial z}\right)_{T,Y_o} \approx 1\times10^{-5}\ m^{-1} \, ,
\end{equation}

\begin{equation}
\frac{1}{\rho_g}\left(\frac{\partial \rho_g}{\partial z}\right)_{T,Z} \approx 5\times10^{-5}\ m^{-1} \, .
\end{equation}

Oil and gas densities are thus approximately constant with depth and their average values can be approximated to the local values at the datum level. The pressure calculated in the material balance equation thus corresponds to the local pressure at $z_{datum}$.

%Under the approximation of a constant density, it is straightforward to show that $\bar{\rho}_\alpha = \rho_\alpha\left(\bar{p}_\alpha\right)$ and $\bar{p}_\alpha=p_\alpha\left(z^0_\alpha\right)$, where $z^0_\alpha$ is the depth of phase gravity center for $\alpha=w, o, g$. 

For the case of an oil reservoir with a gas cap, it is more accurate to define the datum level at the gas-oil contact. The point is that a higher gas density will be computed for a datum level bellow gas-oil contact because of the higher hydrostatic gradient of oil phase,
\begin{equation}
\frac{1}{\rho_g}\left(\frac{\partial \rho_g}{\partial z}\right)_{T,Z} = \frac{\rho_o}{\rho_g}\left(\frac{\mathcal{M}}{Z R T}\right)g  \, ,
\end{equation}
what is $\rho_o / \rho_g$ times greater than the gas hydrostatic gradient used in Eq.~\eqref{eq: gradgdz}.

It was shown that the pressure variation with depth can be neglected for the computation of gas, oil and water densities. This is true provided that phase changes do not occur. 

 for what the pressure variation with depth may not be negligible in the solubility ratio: 
\begin{equation}\label{eq: dRsdz1}
\frac{1}{R_s}\frac{d R_s}{dz} = \frac{1}{R_s}\frac{d R_s}{dp_o} \frac{dp_o}{dz} = \frac{\rho_o g}{R_s}\frac{dR_s}{dp_o} \, .
\end{equation}

For a non-volatile oil, we can approximate $dR_s / dp_o$ to the ratio between the initial solubility ratio ($R_{s,0}$) and saturation pressure ($p_{sat}$), so that Eq.~\eqref{eq: dRsdz1} becomes:
\begin{equation}\label{eq: dRsdz2}
\frac{1}{R_s}\frac{d R_s}{dz} \approx \frac{\rho_o g }{p_{sat}} \approx 10^{-3}\ m^{-1} \, ,
\end{equation}
where the following orders of magnitudes were assumed: $p_{sat} \approx 10^{7}\ Pa$, $\rho_o \approx 10^{3}\ kg/m^3$ and $g \approx 10\ m^2/s$. 

From Eq.~\eqref{eq: dRsdz2}, we see that the variation of pressure with depth may not be negligible for the phase equilibrium,  specially for thick reservoirs of low saturation pressure. In such cases, using an averaged value for the solubility ratio may be worth the accuracy gain in computing dissolved gas volume.

% \subsubsection{Material balance as an equation for reservoir pressure}

%Equations from \eqref{eq: Sw4} to \eqref{eq: S14} constitute the most general form of material balance equation. So far, the only simplification made to black-oil equations was the absence of fluid motion, allowing pressure to be computed from Eqs.\eqref{eq: capillary_ow}, \eqref{eq: capillary_og} and \eqref{eq: p=rhogh}, and equations to be integrated in the entire reservoir volume.

%We now look to solve Eqs. \eqref{eq: Sw5}, \eqref{eq: So5} and \eqref{eq: Sg5} for the averaged quantities. 

%A single equation for pressure may be obtained by substituting Eqs.~\eqref{eq: So5}, \eqref{eq: Sg5} and \eqref{eq: Sw5} into \eqref{eq: S15}. The resulting equation allows pressure to be calculated from given production ($F_p$) and injection ($F_i$) volumes:
%\begin{equation}\label{eq: MBE}
%F_p - F_i= \underbrace{N E_o + mN E_g + W E_w}_{\text{fluid volume expansion } (E)} +\underbrace{V_{p1}-V_{p2}}_{\text{porous volume compaction } (C)}
%\end{equation}
%or
%\begin{equation}\label{eq: MBE_short}
%F_p - F_i= E + C \, ,
%\end{equation}

%where newly introduced terms are defined in Table~\ref{tab: MBE}. Eq.~\eqref{eq: MBE} is commonly referred to as the Material Balance Equation (MBE).

\section{Solution of material balance equation}
A numerical solution of Eq.~\eqref{eq: MBE_short} is presented here. We start by defining a residual function ($\varepsilon$) for which the pressure solving Eq.~\eqref{eq: MBE_short} is a root:
\begin{equation}\label{eq: residual}
\varepsilon(p_2) = \frac{E+F_i+C-F_p}{V_{p1}} \, .
\end{equation}
We proceed showing that $\varepsilon$ is a monotonic function provided some conditions on fluid properties are observed and that only one root of $\varepsilon$ exists at most. Equivalently, we can say that only one solution exists for the material balance equation.

%The conditions imposed on fluid PVT properties are the mathematical equivalent of requiring a far from critical thermodynamic state.

\subsection{Mathematical aspects of the residual function}

It is a known result of real analysis that a monotonic function $f:D\subset\mathcal{R}\rightarrow\mathcal{R}$ can have at most one root in $D$. Further, if $f$ is continuous in the closed interval $I=[a,b] \subset D$ and $f(a)f(b)<0$, then $f$ has one (and only one) root in $I$.

We now state without proof that the following affirmatives are sufficient conditions to classify a function $f$ as monotonic:
%We now show that $\varepsilon$ is a monotonic function since it is:
\begin{enumerate}
\item $f$ is continuous;
\item $f$ is differentiable everywhere except for a countable set of points;
\item $f'<0$ everywhere.
\end{enumerate}

The residual function clearly satisfies the first two affirmatives because phase properties are continuous everywhere and are also differentiable everywhere except  at bubble-point pressure.

The third affirmative is proved by rewriting $d\epsilon/dp$ as a sum of four negative terms:
\begin{equation}\label{eq: deps}
\begin{split}
&V_{p1}\frac{d\varepsilon}{dp}=\underbrace{\left(N-N_p\right) \left(\frac{dB_o}{dp} - B_g \frac{dR_s}{dp} \right)}_\text{oil phase}\\
&+\underbrace{\left[N R_{s1}+mN\frac{B_{o1}}{B_{g1}}+G_i-\left(N-N_p\right)R_{s2}-G_p\right] \frac{dB_g}{dp}}_\text{gas phase}\\
&+\underbrace{\left(W + W_i+W_e-W_p\right)\frac{dB_w}{dp}}_\text{water phase}\\
&\underbrace{-\frac{dV_p}{dp}}_\text{porous volume}\, .
\end{split}
\end{equation}

Each term in Eq. \eqref{eq: deps} corresponds to a different phase (three fluid phases and the solid rock). For the fluid phases, each term is the product of the current volume \textit{in-situ} (a positive quantity) and a volume derivative with respect to pressure (a negative quantity). Since pore volume expands with an increase of fluid pressure, $dV_p/dp$ is positive. The value of $d\varepsilon/dp$ is thus necessarily negative.

In summary, the following four relations constitute sufficient conditions for $\varepsilon(p)$ be a strictly decreasing function and, therefore, for material balance equation to have only one solution:
\begin{equation}\label{eq: PVTH1}
\left(\frac{dB_o}{dp} - B_g \frac{dR_s}{dp} \right) < 0 \, ,
\end{equation}
\begin{equation}\label{eq: PVTH2}
\frac{dB_g}{dp} < 0 \, ,
\end{equation}
\begin{equation}\label{eq: PVTH3}
\frac{dB_w}{dp} < 0 \, ,
\end{equation}
\begin{equation}\label{eq: PVTH4}
\frac{dV_p}{dp} > 0 \, .
\end{equation}

Eq.~\eqref{eq: PVTH1} also provides a condition to check whether PVT data obtained from laboratory or empirical correlations is physically correct. It can be alternatively formulated in terms of densities as shown bellow in Eq.~\eqref{eq: vaporization}. It simply indicates that any vaporization must be followed by an increase in oil phase density:
\begin{equation}\label{eq: vaporization}
\frac{1}{\rho_o}\frac{d\rho_o}{dY_o} > Y_o \left( \frac{\rho_o}{\rho_g} - 1 \right) \, .
\end{equation}


%Switching inequalities to equalities in Eqs.~\eqref{eq: PVTH1}, \eqref{eq: PVTH2} and \eqref{eq: PVTH3} is equivalent to enforcing system incompressibility. Eq.~\eqref{eq: PVTH1}, for instance, would require a volume increase in oil phase to be equal to gas volume in gas phase for any additional gas dissolution.

\subsection{Solution algorithm}
Several methods exist to find roots of nonlinear continuous functions \citep{hamming1987numerical}. One possible choice is Newton's method with a switch from the tangent to the secant line near the non-differentiable bubble-point pressure. Both methods are available in the open source SciPy library \citep{scipy}. This work used the library version $0.12$.

%A more simple and robust option is the bisection method, which does not require the function to be differentiable anywhere. The number of iterations $n$ required to reduce search interval by a factor of $\delta$ is \citep{hamming1987numerical}:
%\begin{equation}
%n=\log_{2} (\delta)+1 \, .
%\end{equation}

%If the inital search interval is $[a;b]$, an error tolerance $|p^{n}-p^{n-1}|\leq (b-a)/\delta $ can be achieved in $21$ iterations for $\delta=10^{6}$.

%Either methods were successfully employed to obtain solution of equations.

The steps to solve the material balance equation are summarized bellow:
\begin{step}
Compute bubble-point pressure for instant $t_2$ using Eq.~\eqref{eq: eqPb}.
\end{step}

Bubble-point pressure $P_{b2}$ is only a function of values at instant $t_1$ and produced and injected volumes.

\begin{step}
Compute pressure for instant $t_2$ by finding the root of residual function $\varepsilon \left(p\right)$.
\end{step}

Pressure in Eq.~\eqref{eq: MBE} is only a function of fluid properties in instant $t_1$, produced and injected values and bubble-point pressure at instant $t_2$, $P_{b2}$, which was already computed in step 1.

\begin{step}
Compute fluid saturations $t_2$.
\end{step}

Once $S_{o2}$, $S_{g2}$, $S_{w2}$, $p_2$ and $P_{b2}$ are known, solution for instant $t_2$ is complete.

\section{Results}
To illustrate the numerical procedure, the material balance equation was solved for a fictitious black-oil reservoir initially producing in a pure depletion drive mechanism and later subjected to water injection. Fig.~\ref{fig: matbal_p} shows in the solid line curve the severe depletion during initial phases of production. In the dashed curve, Fig.~\ref{fig: matbal_p} shows the bubble-point pressure, indicating how far the saturated reservoir is from undersaturation and allowing for planning of pressure maintenance projects.


Water injection starts when oil recovery factor $(RF)$ is $RF=0.08$ and it is maintained until the reservoir reaches a novel undersaturated state. Initially, the high compressibility of gas prevents pressure from raising and free gas phase is reduced because of redissolution. Finally, the reservoir reaches the undersaturated state and a steep pressure increase is seen in Fig.~\ref{fig: matbal_p} for a recovery factor about $RF=0.15$.

It must be observed that the result of gas reentering oil phase completely neglects non-equilibrium effects, e.g. compositional gradients and diffusion of matter, and must be used with care. .

Figure~\ref{fig: matbal_s} shows the formation of a free gas phase with growing $S_g$ and then its disappearance. Depending on the ratio of vertical and horizontal permeabilities or reservoir dip angle, it may also suggest the formation of a secondary gas cap.

Figure~\ref{fig: epsilon} shows the shape of residual function ($\epsilon$) when pressure is varying and all remaining terms are held constant. Each different solid line corresponds to a different instant of time and, therefore, to different volumes of cumulative production and injection. The function root is the solution of material balance equation, Eq.~\eqref{eq: MBE_short}, and the non-differentiable point is the bubble-point pressure. Also, it is seen that function $\epsilon$ monotonically decreases with pressure, as theoretically shown before.

Figure~\ref{fig: iter} shows the count of newtonian iterations required to compute pressure with an accuracy within $0.1\%$ of the initial bubble-point pressure. Typically, $12$ iterations are required.

Figure~\ref{fig: residual} shows the residual of numerical solution as defined in Eq.~\eqref{eq: residual}. Material balance error is less than $10^{-7}$ units of porous volume for all time steps.



\section{Conclusions}
\begin{enumerate}[1.]
\item Material balance equation can be obtained from black-oil equations under the assumptions of:
\begin{enumerate}[(a)]
\item mechanical equilibrium;
\item absence of gravity and capillary forces;
\item spatially constant bubble-point pressure or, equivalently, fluid saturations.
\end{enumerate}
\item One unique solution of pressure equation exists for a compressible system;
\item A residual function can be defined such that its root solves pressure equation. A numerical solution can be obtained with nonlinear root-finding algorithms.
\end{enumerate}

\section*{Nomenclature}
\begin{tabular}{ll}
$B_g$ & gas formation volume factor\\
$B_o$ & oil formation volume factor\\
$B_w$ & water formation volume factor\\
$R_s$ & solubility ratio of gas in oil phase\\
$S_g$ & gas saturation \\
$S_o$ & oil saturation \\
$S_w$ & water saturation \\
$G_p$ & produced volume of gas \\
$m$ & ratio of original free gas volume \\
& to original oil volume at reservoir condition \\
$N$ & original volume of oil in place \\
$N_p$ & produced volume of oil \\
$P_b$ & bubble-point pressure \\
$V_p$ & porous volume \\
$W_i$ & injected volume of water \\
$W_p$ & produced volume of water
\end{tabular}
\section*{References}
\bibliographystyle{elsarticle-harv}
\bibliography{refs}
\cite{*}

%\section*{Highlights}
%\begin{enumerate}[1.]
%\item The existing link between black-oil and material balance equation is examined in detail.
%\item It is shown that gravity and capillary forces must be neglected and saturations must be constant in space so one can integrate black-oil equations in reservoir volume and obtain material balance equation.
%\item Material balance equation are shown to have a unique solution for a compressible system.
%\item Material balance equation are formulated for a variable bubble-point and they are used to a reservoir under pressure maintenance.
%\end{enumerate}

\pagebreak

\begin{figure}
\centering
\includegraphics[width=\linewidth]{./python/matbal_p}
\caption{Reservoir pressure and bubble-point pressure as functions of recovery factor. Once depletion goes below bubble-point, pressure is hardly recovered for a saturated reservoir because of high system compressibility. Pressure is here given in units of the original bubble-point pressure.}
\label{fig: matbal_p}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{./python/matbal_water}
\caption{Volume of water production and injection and aquifer influx.}
\label{fig: matbal_water}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{./python/matbal_gas}
\caption{Volume of gas production.}
\label{fig: matbal_gas}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{./python/matbal_S}
\caption{Phase saturations. Gas saturation is reduced as water injection progresses.}
\label{fig: matbal_s}
\end{figure}


\begin{figure}
\centering
\includegraphics[width=\linewidth]{./python/matbal_res}
\caption{Shape of residual function ($\varepsilon$). Each curve corresponds to different volumes of production and injection. Residual function monotonically decreases with pressure and it has no derivative at the bubble-point.}
\label{fig: epsilon}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{./python/matbal_iter}
\caption{Count of newtonian iterations required to compute pressure with accuracy within $0.001$ units of initial bubble-point presure.}
\label{fig: iter}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{./python/matbal_residual}
\caption{Residual of numerical solution in units of porous volume.}
\label{fig: residual}
\end{figure}

\begin{table*}
\small
\centering
\begin{tabular}{ll}
\toprule
\multicolumn{2}{l}{\textit{Material balance equation}}\\
\midrule
pressure & $F_p - F_i= N E_o + mN E_g + W E_w +C$ \\
\midrule
\multicolumn{2}{l}{\textit{Phase saturations}}\\
\midrule
oil & $S_{o2} = \left(N-N_p\right) B_{o2}/V_{p2}$ \label{eq: oiltab}
\\
water & $S_{w2} = \left(W+W_i+W_e-W_p\right) B_{w2}/V_{p2}$\\
gas & $S_{g2}=\left\lbrace N\left[\left(R_{s1}-R_{s2}\right)+m B_{o1}/B_{g1}\right]+N_p R_{s2}+G_i-G_p\right\rbrace Bg_2/V_{p2}$ \\
\midrule
\multicolumn{2}{l}{\textit{List of terms}} \\
\midrule
fluid production & $F_p=N_p \left[B_{o2} + \left(G_p/N_p -R_{s2}\right)B_{g2}\right]+W_p B_{w2}$ \\
fluid injection and influx & $F_i=\left(W_i +W_e\right) B_{w2}+G_{i}B_{g2}$ \\
fluid expansion & $E=N E_o + mN E_g + W E_w$ \\
oil phase expansion & $E_o=\left(B_{o2}-B_{o1}\right) - \left(R_{so2}-R_{so1}\right)B_{g2}$ \\
gas phase expansion & $E_g = B_{o1}\left(B_{g2}/B_{g1}-1\right)$ \\
water volume expansion & $E_w = B_{w2}-B_{w1}$\\
porous volume compaction & $C=V_{p1}- V_{p2}$\\
bubble-point pressure & $R_{s2}\left(P_b\right) = \left[N\left(m B_{1}/B_{g1} +R_{s1}\right)+G_i-G_p\right]/\left(N-N_p\right)$ \\ \bottomrule
\end{tabular}
\caption{Complete set of material balance equations.}
\label{tab: MBE}
\end{table*}

% % %
% Calcular derivada da função resíduo com relação à pressão.
% % %
\appendix
\include{compressibility}
\end{document}
